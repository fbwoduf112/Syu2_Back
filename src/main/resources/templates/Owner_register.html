<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>매장 소유자 회원가입</title>
  <style>
    .error-message { color: red; display: none; }
    .success-message { color: green; display: none; }
  </style>
</head>
<body>
<h1>매장 소유자 회원가입</h1>
<form id="registerForm">
  <div>
    <label for="ownerEmail">이메일:</label>
    <input type="email" id="ownerEmail" name="ownerEmail" required>
    <button type="button" id="checkEmailBtn">중복확인</button>
    <span id="emailError" class="error-message"></span>
    <span id="emailSuccess" class="success-message">사용 가능한 이메일입니다.</span>
  </div>
  <div>
    <label for="storeName">매장명:</label>
    <input type="text" id="storeName" name="storeName" required>
    <button type="button" id="checkStoreNameBtn">중복확인</button>
    <span id="storeNameError" class="error-message"></span>
    <span id="storeNameSuccess" class="success-message">사용 가능한 매장명입니다.</span>
  </div>
  <div>
    <label for="password">비밀번호:</label>
    <input type="password" id="password" name="password" required>
    <span id="passwordError" class="error-message"></span>
  </div>
  <div>
    <label for="confirmPassword">비밀번호 확인:</label>
    <input type="password" id="confirmPassword" name="confirmPassword" required>
    <span id="confirmPasswordError" class="error-message"></span>
  </div>
  <button type="submit" id="submitBtn">회원가입</button>
</form>
<p>
  <a href="/login">로그인으로 돌아가기</a>
</p>

<script th:inline="javascript">
  let emailValid = false;
  let storeNameValid = false;
  let passwordValid = false;

  // 이메일 중복 검사
  document.getElementById('checkEmailBtn').addEventListener('click', function() {
    const email = document.getElementById('ownerEmail').value;
    if (!email) {
      showError('emailError', '이메일을 입력해주세요.');
      return;
    }

    fetch('/api/stores/checkEmailDuplicate?email=' + encodeURIComponent(email), {
      method: 'POST'
    })
            .then(response => response.json())
            .then(data => {
              if (data === 1) { // 중복
                showError('emailError', '이미 사용 중인 이메일입니다.');
                hideElement('emailSuccess');
                emailValid = false;
              } else { // 사용 가능
                hideError('emailError');
                showElement('emailSuccess');
                emailValid = true;
              }
              validateForm();
            });
  });

  // 매장명 중복 검사
  document.getElementById('checkStoreNameBtn').addEventListener('click', function() {
    const storeName = document.getElementById('storeName').value;
    if (!storeName) {
      showError('storeNameError', '매장명을 입력해주세요.');
      return;
    }

    fetch('/api/stores/checkStoreNameDuplicate?storeName=' + encodeURIComponent(storeName), {
      method: 'POST'
    })
            .then(response => response.json())
            .then(data => {
              if (data === 1) { // 중복
                showError('storeNameError', '이미 사용 중인 매장명입니다.');
                hideElement('storeNameSuccess');
                storeNameValid = false;
              } else { // 사용 가능
                hideError('storeNameError');
                showElement('storeNameSuccess');
                storeNameValid = true;
              }
              validateForm();
            });
  });

  // 비밀번호 유효성 검사
  document.getElementById('password').addEventListener('input', checkPassword);
  document.getElementById('confirmPassword').addEventListener('input', checkPassword);

  function checkPassword() {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    // 비밀번호 길이 검사
    if (password.length < 8) {
      showError('passwordError', '비밀번호는 8자 이상이어야 합니다.');
      passwordValid = false;
    } else {
      hideError('passwordError');

      // 비밀번호 일치 검사
      if (confirmPassword && password !== confirmPassword) {
        showError('confirmPasswordError', '비밀번호가 일치하지 않습니다.');
        passwordValid = false;
      } else if (confirmPassword) {
        hideError('confirmPasswordError');
        passwordValid = true;
      }
    }
    validateForm();
  }

  // 폼 제출
  document.getElementById('registerForm').addEventListener('submit', function(e) {
    e.preventDefault();

    if (!emailValid || !storeNameValid || !passwordValid) {
      alert('모든 필드를 올바르게 입력해주세요.');
      return;
    }

    const storeData = {
      ownerEmail: document.getElementById('ownerEmail').value,
      storeName: document.getElementById('storeName').value,
      provider: 'local'
    };

    const password = document.getElementById('password').value;

    fetch(`/api/stores/register?password=${encodeURIComponent(password)}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(storeData)
    })
            .then(handleResponse)
            .then(handleSuccess)
            .catch(handleError);

    function handleResponse(response) {
      if (response.ok) {
        return response.json();
      } else {
        return response.json().then(data => {
          throw new Error(data.error || '회원가입에 실패했습니다.');
        });
      }
    }

    function handleSuccess(data) {
      alert('매장 소유자 회원가입이 완료되었습니다.');
      window.location.href = '/login';
    }

    function handleError(error) {
      alert(error.message);
    }
  });

  // 폼 유효성 검사
  function validateForm() {
    document.getElementById('submitBtn').disabled = !(emailValid && storeNameValid && passwordValid);
  }

  // 오류 메시지 표시
  function showError(id, message) {
    const element = document.getElementById(id);
    element.textContent = message;
    element.style.display = 'block';
  }

  // 오류 메시지 숨김
  function hideError(id) {
    document.getElementById(id).style.display = 'none';
  }

  // 요소 표시
  function showElement(id) {
    document.getElementById(id).style.display = 'block';
  }

  // 요소 숨김
  function hideElement(id) {
    document.getElementById(id).style.display = 'none';
  }

  // 초기화
  validateForm();
</script>
</body>
</html>